# ğŸš€ Cloud Deployment Guide: Render + Aiven + Cloudinary

Complete guide for deploying Smart Tailoring Service to **FREE** cloud services.

## ğŸ“‹ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Render.com    â”‚â”€â”€â”€â”€â–¶â”‚  Aiven MySQL     â”‚     â”‚  Cloudinary     â”‚
â”‚  (PHP App)      â”‚     â”‚  (Database)      â”‚     â”‚  (Images)       â”‚
â”‚  Free Tier      â”‚     â”‚  Free Tier       â”‚     â”‚  Free Tier      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Why This Stack?

| Service | Purpose | Free Tier Limits |
|---------|---------|------------------|
| **Render** | Web hosting (PHP + Apache) | 750 hours/month, Auto-sleep after 15min idle |
| **Aiven** | Managed MySQL with SSL | 1 GB storage, 1 CPU, 1 GB RAM |
| **Cloudinary** | Image storage & CDN | 25GB storage, 25GB bandwidth/month |

---

## ğŸ“ Prerequisites

- [x] GitHub account
- [x] Render account (sign up at render.com)
- [x] Aiven account (sign up at aiven.io)
- [x] Cloudinary account (sign up at cloudinary.com)
- [x] Your project pushed to GitHub

---

## ğŸ¯ Step 1: Setup Aiven MySQL Database

### 1.1 Create MySQL Service

1. Go to https://console.aiven.io/
2. Click **"Create Service"**
3. Select **MySQL**
4. Choose **Free Plan** (Hobbyist - 1 node)
5. Select region closest to you
6. Service name: `smart-tailoring-db`
7. Click **"Create Service"**

â³ Wait 3-5 minutes for provisioning...

### 1.2 Get Connection Details

Once service is **RUNNING**:

1. Click on your MySQL service
2. Go to **"Overview"** tab
3. Note down:
   ```
   Host: <your-db>.aivencloud.com
   Port: 12345
   User: avnadmin
   Password: <auto-generated>
   Database: defaultdb
   ```

### 1.3 Download SSL Certificate

1. Scroll to **"Connection Information"**
2. Click **"Download CA Certificate"**
3. Save as `ca.pem` in your project root
4. **IMPORTANT:** Add to `.gitignore` (already done in this project)

### 1.4 Create Database

```bash
# Option 1: Use Aiven Web Console
# Go to "Databases" tab â†’ Create database â†’ Name: smart_tailoring

# Option 2: Connect via command line
mysql -h <your-host>.aivencloud.com -P <port> -u avnadmin -p --ssl-ca=ca.pem
```

```sql
CREATE DATABASE smart_tailoring CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE smart_tailoring;
```

---

## ğŸ–¼ï¸ Step 2: Setup Cloudinary

### 2.1 Create Account & Get Credentials

1. Go to https://cloudinary.com/users/register/free
2. Sign up (free tier: 25 GB storage)
3. Go to **Dashboard**
4. Note down:
   ```
   Cloud Name: your-cloud-name
   API Key: 123456789012345
   API Secret: abc123xyz (optional)
   ```

### 2.2 Create Upload Preset (Unsigned)

1. Go to **Settings** â†’ **Upload**
2. Scroll to **"Upload presets"**
3. Click **"Add upload preset"**
4. Settings:
   - **Preset name**: `smart_tailoring_unsigned`
   - **Signing mode**: **Unsigned** âš ï¸ Important!
   - **Folder**: Leave empty or `smart-tailoring/`
   - **Access mode**: Public
5. Click **"Save"**

Note down the **preset name** - you'll need it!

---

## ğŸŒ Step 3: Deploy to Render

### 3.1 Push Code to GitHub

```bash
git add .
git commit -m "feat: Add cloud deployment configuration"
git push origin main
```

### 3.2 Create Web Service on Render

1. Go to https://dashboard.render.com/
2. Click **"New +" â†’ "Web Service"**
3. Connect your GitHub repository
4. Configure:

```yaml
Name: smart-tailoring
Environment: Docker
Branch: main
Dockerfile Path: ./Dockerfile
```

### 3.3 Configure Environment Variables

Click **"Environment"** tab and add these:

#### Database (Aiven)
```env
DB_HOST=<your-db>.aivencloud.com
DB_PORT=12345
DB_USER=avnadmin
DB_PASS=<your-aiven-password>
DB_NAME=smart_tailoring
DB_USE_SSL=true
```

#### Cloudinary
```env
CLOUDINARY_CLOUD_NAME=your-cloud-name
CLOUDINARY_UPLOAD_PRESET=smart_tailoring_unsigned
```

#### Application
```env
APP_ENV=production
APP_DEBUG=false
APP_URL=https://smart-tailoring.onrender.com
```

#### Session
```env
SESSION_STORAGE=file
SESSION_SECURE=true
SESSION_HTTPONLY=true
```

#### SMTP (Optional - for emails)
```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
SMTP_FROM=noreply@smarttailoring.com
```

### 3.4 Deploy!

1. Click **"Create Web Service"**
2. â³ Wait 5-10 minutes for build...
3. âœ… Service will be live at: `https://smart-tailoring.onrender.com`

---

## ğŸ”§ Step 4: Post-Deployment Setup

### 4.1 Run Database Migrations

SSH into Render or use their shell:

```bash
php migrate.php run
```

### 4.2 Create Admin Account

```sql
# Connect to Aiven MySQL
mysql -h <your-host>.aivencloud.com -P <port> -u avnadmin -p --ssl-ca=ca.pem smart_tailoring

# Create admin
INSERT INTO admins (username, password, name, email, role, created_at)
VALUES ('admin', '$2y$10$<hashed_password>', 'Administrator', 'anupamkushwaha639@gmail.com', 'super_admin', NOW());
```

Generate password hash:
```bash
php -r "echo password_hash('your_password', PASSWORD_DEFAULT);"
```

### 4.3 Test Application

1. Visit your Render URL: `https://smart-tailoring.onrender.com`
2. Register a test user
3. Upload a profile image (should go to Cloudinary)
4. Create a test order

---

## âœ… Verification Checklist

- [ ] Application loads without errors
- [ ] Database connection working (check `/api/health.php`)
- [ ] Image upload works (check Cloudinary dashboard)
- [ ] User registration & login functional
- [ ] Sessions persist during use (may clear on restart - expected with file sessions)
- [ ] SSL/HTTPS working (Render provides this automatically)

---

## ğŸ” Troubleshooting

### Issue: "Database connection failed"

**Solution:**
1. Check environment variables in Render dashboard
2. Verify `ca.pem` is in project root
3. Check Aiven service is RUNNING (not stopped)
4. Test connection from local terminal:
   ```bash
   php -r "require 'config/db_cloud.php'; echo db_health_check() ? 'OK' : 'FAIL';"
   ```

### Issue: "Image upload failed"

**Solution:**
1. Verify Cloudinary credentials in Render env vars
2. Check upload preset is **unsigned**
3. Test manually:
   ```bash
   curl -X POST "https://api.cloudinary.com/v1_1/YOUR_CLOUD_NAME/image/upload" \
     -F "upload_preset=YOUR_PRESET" \
     -F "file=@test.jpg"
   ```

### Issue: "Sessions keep logging out"

**Expected Behavior:**
- With `SESSION_STORAGE=file`, sessions clear on Render restart
- This is normal for free tier (auto-sleeps after 15min idle)

**Solutions:**
1. **For demos:** This is acceptable
2. **For production:** Set `SESSION_STORAGE=database` and Render will create `user_sessions` table automatically

### Issue: "App sleeps after inactivity"

**Expected on Render Free Tier:**
- Apps sleep after 15 minutes of inactivity
- First request after sleep takes 30-60 seconds

**Solutions:**
1. **Upgrade to paid plan** ($7/month for always-on)
2. **Use uptime monitoring** (e.g., UptimeRobot pings every 5min - keeps app awake)

---

## ğŸ“Š Cost Breakdown

| Service | Free Tier | Paid Upgrade |
|---------|-----------|--------------|
| **Render** | 750 hrs/month, sleeps after 15min | $7/month (always-on) |
| **Aiven** | 1GB storage, 1 CPU | $28/month (2GB) |
| **Cloudinary** | 25GB storage, 25GB bandwidth | $0 (generous free tier) |
| **Total** | **$0/month** | ~$35/month for production |

---

## ğŸ“ Additional Resources

### Code Changes Required

âœ… **Already Done:**
- `config/db_cloud.php` - SSL database connection
- `utils/cloudinary_helper.php` - Image upload functions
- `config/session_cloud.php` - Stateless session handling
- `Dockerfile` - Render deployment
- `render.yaml` - Service configuration
- `build.sh` - Build automation

### Migration from Local Development

To use cloud-ready files, update your includes:

```php
// OLD (local development):
require_once 'config/db.php';
require_once 'utils/ImageUpload.php';

// NEW (cloud ready):
require_once 'config/db_cloud.php';
require_once 'utils/cloudinary_helper.php';
require_once 'config/session_cloud.php';
```

### Controller Updates

Replace this:
```php
$imageUpload = new ImageUpload('uploads/profiles/');
$result = $imageUpload->upload($_FILES['profile_image'], 'customer_');
$filename = $result['filename'];
```

With this:
```php
require_once 'utils/cloudinary_helper.php';
$result = handleImageUpload($_FILES['profile_image'], 'profiles/customers');
$image_url = $result['url'];
```

---

## ğŸš€ Going Live Checklist

- [ ] Environment variables configured in Render
- [ ] ca.pem certificate added (Aiven SSL)
- [ ] Cloudinary upload preset created
- [ ] Database migrated
- [ ] Admin account created
- [ ] Test user registration working
- [ ] Test image upload working
- [ ] Custom domain configured (optional)
- [ ] SMTP email working (optional)
- [ ] Monitoring setup (UptimeRobot)

---

## ğŸ“ Support

**Created by:** Anupam Kushwaha  
**Email:** anupamkushwaha639@gmail.com  
**LinkedIn:** [linkedin.com/in/anupamkushwaha85](https://linkedin.com/in/anupamkushwaha85)

---

**ğŸ‰ Congratulations! Your application is now running on free cloud infrastructure!**

Note: Render free tier apps sleep after 15 minutes of inactivity. This is normal and expected. First request after sleep will take 30-60 seconds to wake up.
